{% extends "base.html" %}
{% block title %}{{ book.title }} — Электронная библиотека{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-md-4 col-lg-3">
    {% if book.cover and book.cover.filename %}
      <img
        src="{{ url_for('static', filename='covers/' ~ book.cover.filename) }}"
        alt="Обложка: {{ book.title }}"
        class="img-fluid rounded shadow-sm"
        style="width:100%;object-fit:cover;"
      >
    {% else %}
      <div class="bg-light border rounded d-flex align-items-center justify-content-center" style="height:320px;">
        <span class="text-muted">Нет обложки</span>
      </div>
    {% endif %}

    <div class="mt-3">
      <div class="small text-muted">Жанры:</div>
      <div class="mt-1">
        {% if book.genres %}
          {% for bg in book.genres %}
            <span class="badge text-bg-secondary mb-1">{{ bg.genre.name }}</span>
          {% endfor %}
        {% else %}
          <span class="text-muted">—</span>
        {% endif %}
      </div>
    </div>

    <div class="mt-3">
      <div class="small text-muted">Оценка и рецензии:</div>
      <div class="mt-1">
        <span class="fw-semibold">
          {% if book.avg_rating_approved is not none %}
            {{ (book.avg_rating_approved)|round(1) }}
          {% else %}
            —
          {% endif %}
        </span>
        <span class="text-muted"> / {{ book.reviews_count_approved or 0 }} рец.</span>
      </div>
    </div>

    <div class="mt-3 d-grid gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('books.index') }}">← К списку</a>
      {% if current_user.is_authenticated and (current_user.role.name in ['User','Moderator','Admin']) and not my_review %}
        <a class="btn btn-primary btn-sm" href="{{ url_for('reviews.review_new', book_id=book.id) }}">
          Написать рецензию
        </a>
      {% endif %}
    </div>
  </div>

  <div class="col-md-8 col-lg-9">
    <h1 class="h3 mb-1">{{ book.title }}</h1>
    <div class="text-muted mb-3">
      {{ book.author }} · {{ book.publisher }} · {{ book.year }} · {{ book.pages }} стр.
    </div>

    <h2 class="h5 mt-3">Описание</h2>
    <div class="prose">
      {{ description_html | safe }}
    </div>

    <hr class="my-4">

    <h2 class="h5">Рецензии</h2>

    {% if my_review %}
      <div class="card border-primary mb-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <span>Ваша рецензия</span>
          <span class="badge text-bg-light">Оценка: {{ my_review.rating }}</span>
        </div>
        <div class="card-body">
          <div class="text-muted small mb-2">
            {{ my_review.user.full_name if my_review.user else 'Вы' }}, {{ my_review.created_at.strftime('%d.%m.%Y %H:%M') }}
          </div>
          <div>
            {{ (my_review.text | markdown) | safe }}
          </div>
        </div>
      </div>
    {% endif %}

    {% set approved = [] %}
    {% for r in book.reviews %}
      {% if r.status and r.status.name == 'Одобрена' %}
        {% set _ = approved.append(r) %}
      {% endif %}
    {% endfor %}

    {% if approved %}
      {% for r in approved %}
        {% if not (my_review and r.id == my_review.id) %}
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">
                  {{ r.user.full_name if r.user else 'Пользователь' }}
                </div>
                <div>
                  <span class="badge text-bg-secondary">Оценка: {{ r.rating }}</span>
                </div>
              </div>
              <div class="text-muted small mb-2">{{ r.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
              <div>
                {{ (r.text | markdown) | safe }}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="alert alert-info">Одобренных рецензий пока нет.</div>
    {% endif %}
  </div>
</div>
{% endblock %}